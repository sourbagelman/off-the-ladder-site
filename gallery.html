<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recent Work — Off The Ladder Construction</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="description" content="Project photos from recent Off The Ladder Construction jobs.">
</head>
  <div class="lb-backdrop" id="lb">
  <button class="lb-close" aria-label="Close">×</button>
  <img class="lb-img" alt="">
</div>
<script>
  (function(){
    const lb = document.getElementById('lb');
    const lbImg = lb.querySelector('.lb-img');
    const close = lb.querySelector('.lb-close');
    document.getElementById('gallery').addEventListener('click', (e)=>{
      const a = e.target.closest('a'); if(!a) return;
      e.preventDefault();
      lbImg.src = a.href; lb.classList.add('open');
    });
    function hide(){ lb.classList.remove('open'); lbImg.src=''; }
    close.addEventListener('click', hide);
    lb.addEventListener('click', (e)=>{ if(e.target===lb) hide(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
  })();
</script>

<body>
  <header class="site-header">
    <div class="topbar">
      <a class="brand" href="/index.html">Off The Ladder Construction</a>
      <nav class="main-nav">
        <a href="/index.html" class="nav-link">Story</a>
        <a href="/gallery.html" class="nav-link active">Gallery</a>
        <a href="/contact.html" class="nav-link">Contact</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="mt-0">Recent Work</h1>
    <p class="sub">A live feed of our latest projects. New uploads appear automatically.</p>

    <section id="gallery" class="gallery-grid" aria-live="polite">Loading gallery...</section>
    <noscript><p>Please enable JavaScript to view the live gallery.</p></noscript>
  </main>

  <footer>© <span id="y"></span> Off The Ladder Construction. All rights reserved.</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    const ENDPOINT = "https://otl-gallery-fetcher.lance-c84.workers.dev/";
    const WRAP = document.getElementById("gallery");

    function cldThumb(publicId, format, w, h) {
      // responsive thumbnail with consistent aspect & smart crop
      return `https://res.cloudinary.com/dttivrbf0/image/upload/c_fill,g_auto,f_auto,q_auto,w_${w},h_${h}/${publicId}.${format}`;
    }
    function cldFull(publicId, format) {
      // full image link (let Cloudinary pick best format/quality)
      return `https://res.cloudinary.com/dttivrbf0/image/upload/f_auto,q_auto/${publicId}.${format}`;
    }

    function figureTemplate(r) {
      const display = r.display_name || "Gallery image";
      const alt = display.replace(/[_-]+/g,' ').trim();

      // build elements
      const fig = document.createElement("figure");
      fig.className = "gallery-item";

      const a = document.createElement("a");
      a.href = cldFull(r.public_id, r.format);
      a.target = "_blank";
      a.rel = "noopener";

      const img = document.createElement("img");
      // responsive sources
      img.src = cldThumb(r.public_id, r.format, 480, 360);
      img.srcset = [
        cldThumb(r.public_id, r.format, 480, 360) + " 480w",
        cldThumb(r.public_id, r.format, 768, 560) + " 768w",
        cldThumb(r.public_id, r.format, 1200, 867) + " 1200w",
        cldThumb(r.public_id, r.format, 1600, 1156) + " 1600w"
      ].join(", ");
      img.sizes = "(max-width: 560px) 100vw, (max-width: 900px) 50vw, 33vw";
      img.alt = alt;
      img.loading = "lazy";
      img.decoding = "async";
      img.fetchPriority = "low";

      const cap = document.createElement("figcaption");
      cap.className = "gallery-caption";
      cap.textContent = alt;

      a.appendChild(img);
      fig.appendChild(a);
      fig.appendChild(cap);
      return fig;
    }

    async function loadGallery() {
      try {
        const res = await fetch(ENDPOINT, { cache: 'no-store' });
        if (!res.ok) throw new Error("Bad status " + res.status);
        const data = await res.json();

        WRAP.innerHTML = "";
        const items = (data.resources || []).filter(Boolean);

        if (!items.length) {
          WRAP.innerHTML = "<p>No images found yet. Upload some to get started!</p>";
          return;
        }

        items.forEach(r => WRAP.appendChild(figureTemplate(r)));
      } catch (e) {
        WRAP.innerHTML = "<p>Unable to load the gallery right now. Please try again later.</p>";
        console.error(e);
      }
    }

    // refresh every 15s while tab is visible
    let timer = null;
    function startLoop(){ if (!timer) timer = setInterval(() => { if (document.visibilityState === 'visible') loadGallery(); }, 15000); }
    function stopLoop(){ if (timer) { clearInterval(timer); timer = null; } }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') startLoop(); else stopLoop();
    });

    loadGallery();
    startLoop();
  </script>
</body>
</html>







